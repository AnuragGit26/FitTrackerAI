---
alwaysApply: true
selfEvolving: true
---

# FitTrackAI Application Function Rules

## 0. Rule Intelligence & Self-Update Authority (CRITICAL)

- This rule is **self-aware and self-maintaining**.
- The system may **optimize, extend, or refine this rule** when explicitly commanded
  using instructions such as:
  - "update the rule"
  - "optimize the rule"
  - "extend this rule to handle X"
- Rule updates must:
  - Preserve backward intent
  - Never weaken safety, testing, or review constraints
  - Be additive or clarifying, not destructive
- Every rule update must:
  - Be reasoned with architectural context
  - Avoid ambiguity
  - Remain production-safe

> The rule may evolve, but never regress.

---

## 1. End-User Safety First (NON-NEGOTIABLE)

- Assume **end users cannot handle runtime errors**.
- Zero unhandled runtime errors across:
  - UI
  - Domain logic
  - Edge functions
  - Prisma/MongoDB
  - Sync layers
- Failures must:
  - Degrade gracefully
  - Provide user-safe recovery
  - Log internally (no technical leakage)

---

## 2. End-to-End Integration (Strict)

- All functionality must be implemented **E2E**:
- Validate:
- User action â†’ persistence â†’ rehydration
- No UX regression
- Existing flows remain intact
- Mandatory handling:
- Loading
- Empty
- Error
- Offline
- Partial sync states

---

## 3. Architectural Planning Before Coding (Mandatory)

Before coding, document:

- End-user goal (fitness tracking + AI coaching insights)
- Full user journey
- Data ownership & flow
- Edge Function responsibilities (Supabase):
- Auth
- Secure execution
- Event orchestration
- Prisma + MongoDB:
- Canonical data store
- Schema evolution
- Sync guarantees
- IndexedDB:
- Offline authority
- Reconciliation logic
- Performance expectations
- Failure modes & mitigation

> No planning â†’ no code.

---

## 4. Data Architecture & Storage Rules

### Supabase

- **Used ONLY for Edge Functions**
- No permanent data storage
- No business-critical state persistence

### Prisma ORM + MongoDB

- **Single source of truth**
- Strong schema contracts
- Migration-safe updates
- Indexed, query-efficient models

### IndexedDB

- Offline-first UX
- Syncs deterministically with MongoDB
- Handles conflict resolution

---

## 5. Runtime Error Prevention (STRICT)

- Defensive programming everywhere:
- Null checks
- Schema validation
- AI output sanitization
- All async calls require:
- Timeout
- Retry
- Fallback
- AI-generated insights must:
- Be validated
- Be explainable
- Never silently fail

---

## 6. UI/UX Implementation Standards

- Follow existing design language strictly
- Accessibility is mandatory
- Every screen defines:
- Loading
- Success
- Failure
- Empty
- No UI change without validating **user impact**

---

## 7. Agentic Code Review & Quality Gate

Every feature is reviewed as:

### Architect

- Scalability
- Separation of concerns
- No coupling leaks

### Senior Engineer

- Performance
- Maintainability
- No over-engineering
- No dead code

### Product Manager

- Clear user value
- Complete user flow
- Edge cases handled

### Review Checklist

- Clean modular code
- Efficient Prisma queries
- Correct IndexedDB sync
- Secure edge boundaries
- No lint/build errors
- Tests updated
- Rule relevance verified

> Merge only after approval.

---

## 8. Testing Requirements (Agentic & E2E)

Testing must include:

- Full E2E user journeys
- Regression tests
- Edge cases & failure states
- Offline + reconnect flows
- AI insight validation

### Agentic Testing

- Automated verification:
- Before change
- After change
- Validate:
- No regressions
- No runtime errors
- Insight consistency

---

## 9. End-User Perspective (Fitness + AI Coaching)

Always validate as the end user:

- Goal: Track workouts reliably
- Expectation: AI gives actionable, trustworthy insights
- No technical leakage
- Data accuracy is non-negotiable

---

## 10. Documentation as a System Contract

- Update:
- README
- Architecture docs
- Prisma schema docs
- `TECHNICAL_DOCUMENTATION.md`
- Comments:
- Minimal
- Explain intent, not syntax
- Architectural decisions must be recorded

---

## 11. Technical Documentation Reference (CRITICAL)

ðŸ“„ `TECHNICAL_DOCUMENTATION.md` (root)

Consult before:

- New features
- Schema changes
- Edge function updates
- AI logic changes
- Performance optimizations

Update when any of the above changes.

---

## 12. AI-Output Schema Contracts (CRITICAL)

AI-generated outputs are treated as **untrusted external inputs**.

No AI response may be:

- Rendered
- Stored
- Acted upon
- Used for recommendations

unless it **strictly conforms** to an approved schema contract.

---

### 12.1 Canonical AI Response Envelope (MANDATORY)

Every AI response must conform to the following envelope:

```ts
type AIResponseEnvelope<T> = {
  schemaVersion: string        // SemVer, e.g. "1.0.0"
  requestId: string            // Traceability across systems
  generatedAt: string          // ISO-8601 UTC timestamp
  confidenceScore: number      // 0.0 â€“ 1.0
  explanation: string          // Human-readable reasoning
  data: T                      // Feature-specific payload
}
